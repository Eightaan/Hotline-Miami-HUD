if VHUDPlus and VHUDPlus:getSetting({"CustomHUD", "HUDTYPE"}, 2) == 3 or WolfHUD then
    return
end

if RequiredScript == "lib/managers/playermanager" then
	Hooks:PreHook(PlayerManager, "activate_temporary_upgrade", "activate_temporary_upgrade_armor_timer", function (self, category, upgrade)
		if upgrade == "armor_break_invulnerable" then
			local upgrade_value = self:upgrade_value(category, upgrade)
			if upgrade_value == 0 then return end
			local teammate_panel = managers.hud:get_teammate_panel_by_peer()
			if teammate_panel then
			    if HMH:GetOption("armorer_cooldown_timer") then
				    teammate_panel:update_cooldown_timer(upgrade_value[2])
				end
				if HMH:GetOption("armorer_cooldown_radial") then
				    teammate_panel:animate_invulnerability(upgrade_value[1])
				end
			end
		end
	end)
elseif RequiredScript == "lib/managers/hud/hudteammate" then	
	local init_original = HUDTeammate.init

	function HUDTeammate:init(...)
		init_original(self, ...)
		if self._main_player then
			self:_init_armor_timer()
		end
	end
		
	function HUDTeammate:_init_armor_timer()
    	self._health_panel = self._health_panel or self._player_panel:child("radial_health_panel")
		self._cooldown_timer = self._health_panel:text({
			name = "cooldown_timer",
			text = "",
			color = Color.white,
			visible = false,
			align = "center",
			vertical = "center",
			y = HMH:GetOption("ability_icon") and 10 or 0,
			font = tweak_data.hud.medium_font_noshadow,
			font_size = 16,
			layer = 4
		})
		self._cooldown_icon = self._health_panel:bitmap({
			name = "cooldown_icon",
			texture = "guis/dlcs/opera/textures/pd2/specialization/icons_atlas",
			texture_rect = {0, 0, 64, 64},
			valign = "center",
			x = 14,
			y = 15,
			w = 40,
			h = 40,
			color = HMH:GetColor("Ability_icon_color") or Color.white,
			visible = false,
			align = "center",
			layer = 3
		})
	end

	function HUDTeammate:update_cooldown_timer(t)
    	if t and t > 1 and self._cooldown_timer then
        	self._cooldown_timer:stop()
			self._cooldown_icon:set_visible(HMH:GetOption("ability_icon"))
			if HMH:GetOption("stamina") and self._stamina_bar and (not HMH:GetOption("armorer_cooldown_radial") or HMH:GetOption("ability_icon")) then 
	  	    	self._stamina_bar:set_alpha(0) 
			end
        	self._cooldown_timer:animate(function(o)
            	o:set_visible(true)
            	local t_left = t
            	while t_left >= 0 and not managers.player:player_unit():character_damage().swansong do
                	t_left = t_left - coroutine.yield()
                	o:set_text(string.format("%.1f", t_left))
					o:set_color(HMH:GetColor("armorer_cooldown_timer_color") or Color.red)
            	end
            	o:set_visible(false)
				self._cooldown_icon:set_visible(false)
				if HMH:GetOption("stamina") and self._stamina_bar then 
			    	self._stamina_bar:set_alpha(1) 
				end
        	end)
    	end
	end

	function HUDTeammate:animate_invulnerability(duration)
  		self._radial_health_panel:child("radial_custom"):animate(function (o)
    		o:set_color(Color(1, 1, 1, 1))
			self._cooldown_timer:set_alpha(0)
			if HMH:GetOption("stamina") and self._stamina_bar and HMH:GetOption("ability_icon") then 
	  	    	self._stamina_bar:set_alpha(0) 
			end
			self._cooldown_icon:set_visible(HMH:GetOption("ability_icon"))
			self._cooldown_icon:set_alpha(1)
    		o:set_visible(true)
    		over(duration, function (p)
      			o:set_color(Color(1, 1 - p, 1, 1))
    		end)
    		o:set_visible(false)
		    self._cooldown_timer:set_alpha(1)
			if HMH:GetOption("stamina") and self._stamina_bar and not HMH:GetOption("armorer_cooldown_timer") then 
			    self._stamina_bar:set_alpha(1) 
			end
			if not HMH:GetOption("armorer_cooldown_timer") then 
			    self._cooldown_icon:set_visible(false)
			end
			self._cooldown_icon:set_alpha(0.4)
  		end)
	end
end